# DMA

# STM32F4 DMA简介
DMA，全称为：Direct Memory Access，即直接存储器访问。DMA 传输方式无需 CPU 直接控制传输，也没有中断处理方式那样保留现场和恢复现场的过程，通过硬件为 RAM 与 I/O 设备开辟一条直接传送数据的通路，能使 CPU 的效率大为提高。

# DMA设置的相关寄存器

##  DMA 中断状态寄存器:DMA_LISR DMA_HISR
第一个是 DMA 中断状态寄存器，该寄存器总共有 2 个：DMA_LISR 和 DMA_HISR，每个寄存器管理 4 数据流（总共 8 个），DMA_LISR 寄存器用于管理数据流 0~3，而 DMA_HISR 用于管理数据流 4~7。这两个寄存器各位描述都完全一模一样，只是管理的数据流不一样。

![Img](/00-嵌入式软件工程师/06-通讯协议详解/00-其它/01-DMA/FILES/DMA.md/img-20230625161739.png)


## DMA中断标志清除寄存器

该寄存器同样有 2 个：DMA_LIFCR 和 DMA_HIFCR，同样是每个寄存器控制 4 个数据流，DMA_LIFCR 寄存器用于管理数据流 0~3，而 DMA_ HIFCR 用于管理数据流 4~7。这两个寄存器各位描述都完全一模一样，只是管理的数据流不一样。

![Img](/00-嵌入式软件工程师/06-通讯协议详解/00-其它/01-DMA/FILES/DMA.md/img-20230625162750.png)


##  DMA 数据流 x 配置寄存器
（DMA_SxCR）（x=0~7）
《STM32F4xx 中文参考手册》第 223 页 9.5.5 一节

该寄存器控制着 DMA 的很多相关信息，包括数据宽度、外设及存储器的宽度、优先级、增量模式、传输方向、中断允许、使能等都是通过该寄存器来设置的。所以 DMA_ SxCR 是 DMA 传输的核心控制寄存器。


##  DMA 数据流 x 数据项数寄存器（DMA_SxNDTR）
这个寄存器控制 DMA 数据流 x 的每次传输所要传输的数据量。其设置范围为 0~65535。并且该寄存器的值会随着传输的进行而减少，当该寄存器的值为 0 的时候就代表此次数据传输已经全部发送完成了。所以可以通过这个寄存器的值来知道当前 DMA 传输的进度。特别注意，这里是数据项数目，而不是指的字节数。比如设置数据位宽为 16 位，那么传输一次（一个项）就是 2 个字节。


## DMA数据流x的外设地址寄存器（DMA_SxPAR)
该寄存器用来存储 STM32F4 外设的地址，比如我们使用串口 1，那么该寄存器必须写入 0x40011004（其实就是&USART1_DR）。如果使用其他外设，就修改成相应外设的地址就行了。


## DMA数据流x的存储器地址寄存器

 STM32F4 的 DMA 支持双缓存，所以存储器地址寄存器有两个：DMA_SxM0AR 和 DMA_SxM1AR，其中 DMA_SxM1AR 仅在双缓冲模式下，才有效。本章我们没用到双缓冲模式，所以存储器地址寄存器就是：DMA_SxM0AR，该寄存器和DMA_CPARx 差不多，但是是用来放存储器的地址的。比如我们使用 SendBuf[8200]数组来做存储器，那么我们在 DMA_SxM0AR 中写入&SendBuff 就可以了。









